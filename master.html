<html>

    <head>
        <title>Farhi model</title>
    <head>
    
    <body>
        <canvas id='model' width='1000' height='1000'>
        </canvas>
        <div id='graph1' width='1000' height='1000'></div>
        <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script>
            var width=800;
            
            var atmpo2 = 150;
            var alvpo2 = 100;
            var pao2 = 100;
            var pvo2 = 40;
            var ptissueo2 = 50;
            var pvco2 = 50;
            var paco2 = 40;
            var ptissueco2 = 50;
            
            var res1 = 5;
            var res2 = 5;
            var res3 = 5;
            var res4 = 5;
            var res5 = 5;
            var res6 = 5;
            
            var atmvol = 40;
            var alvo2vol = 10;
            var artso2 = [];
            var venso2 = [];
            var vo2vol = 20;
            var tissueo2vol = 5;
            var tissueco2vol = 40;
            var vensco2 = [];
            var artsco2 = [];
            var alvco2vol = 5;
            var vollist;
            var po2list;
            
            function SHbO2CO2 (pO2=100, pCO2=40, pH=7.4, DPG=4.65e-3, Temp=37 ,Hb=15)
            {
                var Hct = Hb*3/100;
                //Parameters those are fixed in the model (i.e., water fractions, hemoglobin
                //concentration in RBCs, equilibrium constants, and Hill coefficient)
                var Wpl = 0.94;             // fractional water space in plasma; unitless
                var Wrbc = 0.65;            // fractional water space in RBCs; unitless
                var Rrbc = 0.69;           // Gibbs-Donnan ratio across RBC membrane; unitless
                var Hbrbc = 5.18e-3;        // hemoglobin concentration in RBCs; M
                var K2 = 2.95e-5;           // CO2 + HbNH2 equilibrium constant; unitless
                var K2dp = 1.0e-6;          // HbNHCOOH dissociation constant; M
                var K2p = K2/K2dp;          // kf2p/kb2p; 1/M
                var K3 = 2.51e-5;           // CO2 + O2HbNH2 equilibrium constant; unitless
                var K3dp = 1.0e-6;          // O2HbNHCOOH dissociation constant; M
                var K3p = K3/K3dp;          // kf3p/kb3p; 1/M
                var K5dp = 2.63e-8;         // HbNH3+ dissociation constant; M
                var K6dp = 1.91e-8;         // O2HbNH3+ dissociation constant; M
                var nhill = 2.7;            // Hill coefficient; unitless
                var n0 = nhill-1.0;         // deviation of Hill coefficient or cooperativity from
                                           // the stochiometry of O2 for each heme site
    
                // Variables those are privately fixed in the model with the standard 
                // physiological values (i.e., pH0, pCO20, DPG0, Temp0)
                var pO20 = 100.0;           // standard O2 partial pressure in blood; mmHg
                var pCO20 = 40.0;           // standard CO2 partial pressure in blood; mmHg
                var pH0 = 7.24;             // standard pH in RBCs; unitless
                var DPG0 = 4.65e-3;         // standard 2;3-DPG concentration in RBCs; M
                var Temp0 = 37.0;           // standard temperature in blood; degC
                var fact = 1.0e-6/Wpl;      // a multiplicative factor; M/mmHg
                var alphaO20 = fact*1.37;	//solubility of O2 in water at 37 C; M/mmHg
                var alphaCO20 = fact*30.7;	// solubility of CO2 in water at 37 C; M/mmHg
                var O20 = alphaO20*pO20;	// standard O2 concentration in RBCs; M
                var CO20 = alphaCO20*pCO20;	// standard CO2 concentration in RBCs; M
                var Hp0 = 10**(-pH0);        // standard H+ concentration in RBCs; M
                var pHpl0 = pH0-Math.log10(Rrbc);	// standard pH in plasma; unitless
                var P500 = 26.8;            // standard pO2 at 50% SHbO2; mmHg
                var C500 = alphaO20*P500;	// standard O2 concentration at 50% SHbO2; M
                https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Functions
                // Calculation of intermediate variables and the indices n1, n2, n3, and 
                // n4 in the computations of SHbO2 & SHbCO2
                var Wbl = (1-Hct)*Wpl + Hct*Wrbc;
                var pHpl = pH-Math.log10(Rrbc);
                var pHpldiff = pHpl-pHpl0;
                var pHdiff = pH-pH0;
                var pCO2diff = pCO2-pCO20;
                var DPGdiff = DPG-DPG0;
                var Tempdiff = Temp-Temp0;
                var alphaO2 = fact*(1.37 - 0.0137*Tempdiff + 0.00058*Tempdiff**2);
                var alphaCO2 = fact*(30.7 - 0.57*Tempdiff + 0.02*Tempdiff**2);
                var pK1 = 6.091 - 0.0434*pHpldiff + 0.0014*Tempdiff*pHpldiff;
                var K1 = 10**(-pK1);
                var O2 = alphaO2*pO2;
                var CO2 = alphaCO2*pCO2;
                var Hp = 10**(-pH);
                var Hppl = 10**(-pHpl);
                
                var Term1 = K2p*(1+K2dp/Hp);
                var Term2 = K3p*(1+K3dp/Hp);
                var Term3 = (1+Hp/K5dp);
                var Term4 = (1+Hp/K6dp);
                var Term10 = K2p*(1+K2dp/Hp0);
                var Term20 = K3p*(1+K3dp/Hp0);
                var Term30 = (1+Hp0/K5dp);
                var Term40 = (1+Hp0/K6dp);
                var Kratio10 = (Term10*CO20+Term30)/(Term20*CO20+Term40);
                var Kratio11 = (Term1*CO20+Term3)/(Term2*CO20+Term4);
                var Kratio12 = (Term10*alphaCO20*pCO2+Term30)/(Term20*alphaCO20*pCO2+Term40);
                var K4dp = Kratio10*O20**n0/C500**nhill;
                var K4tp = K4dp/O20**n0;
                var Kratio20 = Kratio10/K4tp;
                var Kratio21 = Kratio11/K4tp;
                var Kratio22 = Kratio12/K4tp;
                
                var P501 = 26.765 - 21.279*pHdiff + 8.872*pHdiff**2;
                var P502 = 26.80 + 0.0428*pCO2diff + 3.64e-5*pCO2diff**2;
                var P503 = 26.78 + 795.633533*DPGdiff - 19660.8947*DPGdiff**2;
                var P504 = 26.75 + 1.4945*Tempdiff + 0.04335*Tempdiff**2 + 0.0007*Tempdiff**3;
                var C501 = alphaO20*P501;
                var C502 = alphaO20*P502;
                var C503 = alphaO20*P503;
                var C504 = alphaO2*P504;
                
                if (Math.abs(pH-pH0) < 1.0e-6){
                    n1 = 1.0;       // can be any arbitrary value
                } else {
                    n1 = (Math.log10(Kratio21)-nhill*Math.log10(C501))/(pH-pH0);}
    
                if (Math.abs(pCO2-pCO20) < 1.0e-6){ 
                    n2 = 1.0       // can be any arbitrary value
                } else {
                    n2 = (Math.log10(Kratio22)-nhill*Math.log10(C502))/(Math.log10(CO20)-Math.log10(CO2))}
                
                if (Math.abs(DPG-DPG0) < 1.0e-6) {
                    n3 = 1.0        // can be any arbitrary value
                } else {
                    n3 = (Math.log10(Kratio20)-nhill*Math.log10(C503))/(Math.log10(DPG0)-Math.log10(DPG))}
                
                if (Math.abs(Temp-Temp0) < 1.0e-6){
                    n4 = 1.0       // can be any arbitrary value
                } else {
                    n4 = (Math.log10(Kratio20)-nhill*Math.log10(C504))/(Math.log10(Temp0)-Math.log10(Temp))}
                
                var Term5 = (Hp0/Hp)**n1*(CO20/CO2)**n2*(DPG0/DPG)**n3*(Temp0/Temp)**n4;
                
                // Calculation of Hill coefficients (KHbO2 and KHbCO2); O2 and CO2 saturations
                // of hemoglobin (SHbO2 and SHbCO2); and O2 and CO2 contents in blood. These 
                // are computed as functions of pO2 and pCO2. Also compute the concentrations
                // of all the components of HbO2 and HbCO2.
                var K4p = K4dp*(O2/O20)**n0*Term5;
                var KHbO2 = K4p*(Term2*CO2+Term4)/(Term1*CO2+Term3);
                var KHbCO2 = (Term1+Term2*K4p*O2)/(Term3+Term4*K4p*O2);
                var SHbO2 = KHbO2*O2/(1+KHbO2*O2);
                var SHbCO2 = KHbCO2*CO2/(1+KHbCO2*CO2);
                var O2free = Wbl*alphaO2*pO2 * 2225.6;
                var O2bound = 4*Hct*Hbrbc*SHbO2 * 2225.6;
                var O2total = O2free+O2bound;
                var CO2free = Wbl*alphaCO2*pCO2 * 2225.6;
                var CO2bicarb = ((1-Hct)*Wpl+Hct*Wrbc*Rrbc)*(K1*alphaCO2*pCO2/Hppl) *2225.6;
                var CO2bound = 4*Hct*Hbrbc*SHbCO2 * 2225.6;
                var CO2total = CO2free+CO2bicarb+CO2bound;
                
                return([SHbO2,SHbCO2]);
            };
            
            
            var lineDiv = document.getElementById('graph1');
            
            var x = [];
            var y = [];
            
            for (i=0; i<100; i++)
            {   x.push(i);
                y.push(SHbO2CO2(pO2 =40, pco2=i)[1]);}
            
            var traceA = {
            x: x,
            y: y,
            type: 'scatter'
            };
            
            var data = [traceA];
                    
            Plotly.plot( lineDiv, data);
            
            
            var modelUI = 
            {
                init : function() 
                {
                    this.set_values();
                    this.draw();
                },
                
                set_values : function()
                {
                    for (i=0; i<151; i++) {
                        artso2[i]=SHbO2CO2(pO2=i)[0];
                    };
                    for (i=0; i<151; i++) {
                        venso2[i]=SHbO2CO2(pO2=i, pCO2=50)[0];
                    };
                    for (i=0; i<101; i++) {
                        vensco2[i]=SHbO2CO2(pO2=40, pCO2=i)[1];
                    };
                    for (i=0; i<101; i++) {
                        artsco2[i]=SHbO2CO2(pO2=100, pCO2=i)[1];
                    };
                },
                
                draw : function() 
                {
                    canvas = document.getElementById('model');
                    ctx = canvas.getContext('2d');
                    ctx.beginPath();
                    
                    var startx = 100;
                    var starty = 100;
                    var ht = 300;
                    //atmosphere
                    ctx.moveTo(startx,starty);
                    ctx.lineTo(startx,starty+ht);
                    ctx.moveTo(startx+atmvol,starty);
                    ctx.lineTo(startx+atmvol,starty+ht-res1);
                    //alveoli
                    ctx.moveTo(startx+200,starty);
                    ctx.lineTo(startx+200,starty+ht-res1);
                    ctx.moveTo(startx+200+alvo2vol,starty);
                    ctx.lineTo(startx+200+alvo2vol,starty+ht-res2);
                    //arterial o2
                    ctx.moveTo(startx+250,starty);
                    ctx.lineTo(startx+250,starty+ht-res2);
                    ctx.moveTo(startx+250+(1-artso2[0])*20,starty+ht-res2);
                    for (i=0; i<150-res2; i++) {
                        ctx.lineTo(startx+250+(1-artso2[i])*20, starty+ht-res2-Math.abs(ht/150*i));
                    };
                    //venous o2
                    ctx.moveTo(startx+400,starty);
                    ctx.lineTo(startx+400,starty+ht-res2);
                    ctx.moveTo(startx+400+(1-venso2[0])*60, starty+ht-res3);
                    for (i=0; i<150-res3; i++) {
                        ctx.lineTo(startx+400+(1-venso2[i])*60, starty+ht-res3-Math.abs(ht/150*i));
                    };
                    //tissueo2
                    ctx.moveTo(startx+550,starty);
                    ctx.lineTo(startx+550,starty+ht-res3);
                    ctx.moveTo(startx+550+tissueo2vol,starty);
                    ctx.lineTo(startx+550+tissueo2vol,starty+ht-2);
                    //tissueco2
                    ctx.moveTo(startx+700,starty+ht+50);
                    ctx.lineTo(startx+700,starty+ht+50+ht-100);
                    ctx.moveTo(startx+480,starty+ht+50);
                    ctx.lineTo(startx+480,starty+ht+50+ht-100-res4);
                    //venco2
                    ctx.moveTo(startx+460,starty+ht+50);
                    ctx.lineTo(startx+460,starty+ht+50+ht-100-res4);
                    ctx.moveTo(startx+400+(1-vensco2[0])*60,starty+ht+50+ht-100-res5);
                    for (i=0; i<100-res5; i++) {
                        ctx.lineTo(startx+400+(1-vensco2[i])*60, starty+ht+50+ht-100-res5-Math.abs(ht/100*i));
                    };
                    
                    
                    ctx.stroke();
                },
                shapeToFitScreen : function()
                {
                    if (window.innerWidth <= window.innerHeight)
                    {
                        this.width = window.innerWidth-10;
                        this.left_margin = 5;
                        this.top_margin = 0.5*(window.innerHeight-this.width);
                    }
                    else
                    {
                        this.width = window.innerHeight-10;
                        this.left_margin = 0.5*(window.innerWidth-this.width);
                        this.top_margin = 5;
                    }
                    document.body.style.marginLeft = this.left_margin;
                    document.body.style.marginTop = this.top_margin;
                    model.style.width = this.width;
                }
            }
            modelUI.init();
            requestAnimationFrame(redraw);
            
            function redraw(highResTimestamp)
            {
                modelUI.shapeToFitScreen();
                modelUI.draw();
                requestAnimationFrame(redraw);
                time = Date.now()/1000;
            }    
            
        </script>
        
        

    </body>
</html>
